var optapp=angular.module("optapp",["ngRoute","facapp","ngAnimate","ui.bootstrap"]);optapp.config(function($routeProvider,$locationProvider){$routeProvider.when("/",{templateUrl:"/options/collect.html",controller:"collCtr"}).when("/type",{templateUrl:"/options/type.html",controller:"typeCtr"}).when("/order",{templateUrl:"/options/order.html",controller:"orderCtr"}).when("/feedback",{templateUrl:"/options/feedback.html",controller:"feedbackCtr"}).when("/agent",{templateUrl:"/options/agent.html",controller:"agentCtr"}).when("/pay",{templateUrl:"/options/pay.html",controller:"payCtr"})}),optapp.run(function($rootScope,$location){$rootScope.$on("$routeChangeStart",function(event,next,current){var cToken=localStorage.getItem("token");null==cToken&&(chrome.browserAction.setIcon({path:"images/icon-never.png"},function(){}),chrome.browserAction.setBadgeText({text:""}),chrome.tabs.getCurrent(function(tab){chrome.tabs.update(tab.id,{url:chrome.extension.getURL("login.html")})}))})}),optapp.controller("mainCtr",function($scope,$http,faConfig,fwToolbar,$uibModal,$location){var main=$scope.main={};main.username=localStorage.getItem("username"),null!=localStorage.getItem("hostname")?main.baseUrl=localStorage.getItem("hostname"):main.baseUrl=faConfig.ajaxUrl,main.days=localStorage.getItem("days");var manifest=chrome.runtime.getManifest();if(main.version=manifest.version,main.versionServer=localStorage.getItem("version"),null!=localStorage.getItem("pss")){var pss=localStorage.getItem("pss");main.pss=angular.fromJson(pss)}main.logOut=function(){var cToken=localStorage.getItem("token"),username=localStorage.getItem("username");null!=cToken&&$http.post(faConfig.ajaxUrl+"index.php?r=member/loginout",{token:cToken,username:username}).success(function(data,status,headers,config){localStorage.removeItem("token"),localStorage.removeItem("username"),localStorage.removeItem("urls"),fwToolbar.setPac(!1),chrome.tabs.getCurrent(function(tab){chrome.tabs.update(tab.id,{url:chrome.extension.getURL("login.html")})})}).error(function(data,status,headers,config){})},main.editPwd=function(){$uibModal.open({animation:!0,templateUrl:"editPwd.html",controller:"ModalInstanceCtrl",size:"sm",resolve:{main:main}})},main.editServer=function(){$uibModal.open({animation:!0,templateUrl:"servList.html",controller:"ModalServerCtrl",size:"lg",resolve:{main:main}})}}),optapp.controller("ModalServerCtrl",function($scope,$uibModalInstance,main,fwToolbar,$http,faConfig){$scope.showSMsg="服务器列表载入中...";var cToken=localStorage.getItem("token"),username=localStorage.getItem("username");$scope.current={host:main.pss.sshost},$http.post(faConfig.ajaxUrl+"index.php?r=option/allsserver",{token:cToken,username:username}).success(function(data,status,headers,config){fwToolbar.prOtherlogin(data),$scope.sslist=data.sslist,$scope.showSMsg=""}),$scope.toSEdit=function(){$scope.dis=!0;var pss=localStorage.getItem("pss");pss=angular.fromJson(pss),$scope.current.host==pss.sshost?$uibModalInstance.dismiss("cancel"):($scope.showSMsg="正在切换服务器，请稍后...",$http.post(faConfig.ajaxUrl+"index.php?r=option/setssserver",{token:cToken,username:username,sshost:$scope.current.host}).success(function(data,status,headers,config){if(fwToolbar.prOtherlogin(data),1==data.code){if(localStorage.setItem("ps",data.s),localStorage.setItem("pss",data.ss),main.pss=angular.fromJson(data.ss),null!=localStorage.getItem("mode")){var mode=localStorage.getItem("mode");1==mode&&fwToolbar.setPac(!0),2==mode&&fwToolbar.setAlwaysPac(!0),3==mode&&(fwToolbar.setPac(!1),fwToolbar.setAlwaysPac(!1))}else fwToolbar.setPac(!0);$uibModalInstance.dismiss("cancel")}else $scope.showSMsg="你的账号已过期，不能切换服务器",$scope.dis=!1}))},$scope.cancelS=function(){$uibModalInstance.dismiss("cancel")}}),optapp.controller("ModalInstanceCtrl",function($scope,$uibModalInstance,main,fwToolbar,$http,faConfig){$scope.cancel=function(){$uibModalInstance.dismiss("cancel")},$scope.showErr=!1,$scope.showMsg="",$scope.toEdit=function(){if("undefined"==typeof $scope.pwd1||"undefined"==typeof $scope.pwd2||"undefined"==typeof $scope.oldpwd)return $scope.showErr=!0,$scope.showMsg="不能为空，长度必须6位",!1;if($scope.pwd1!=$scope.pwd2)return $scope.showErr=!0,$scope.showMsg="两次密码不一致",!1;var cToken=localStorage.getItem("token"),username=localStorage.getItem("username");$http.post(faConfig.ajaxUrl+"index.php?r=option/editpwd",{token:cToken,username:username,pwd:$scope.pwd2,oldpwd:$scope.oldpwd}).success(function(data,status,headers,config){return fwToolbar.prOtherlogin(data),-3==data.code?($scope.showErr=!0,$scope.showMsg=data.msg,!1):(alert("修改成功"),void $uibModalInstance.dismiss("cancel"))}).error(function(data,status,headers,config){})}}),optapp.controller("menuCtr",function($scope,$http,faConfig,$location){var menu=$scope.menu={};menu.isActive=function(viewLocation){return viewLocation===$location.path()}}),optapp.controller("collCtr",function($scope,$compile,$http,fwToolbar,optionProcess,faConfig){fwToolbar.setPac(!0);var collect=$scope.collect={};collect.showOk=!1;var cToken=localStorage.getItem("token");$scope.type={},null!=cToken&&(fwToolbar.getAllCollect($scope.collect),optionProcess.getTypeAll($scope,cToken)),collect.add=function(url_form){if(url_form.$valid){var typeid=0;"undefined"!=typeof collect.type&&(typeid=collect.type.mwt_id),-1==collect.weburl.indexOf("http://")&&(collect.weburl="http://"+collect.weburl);var shorturl=fwToolbar.getShortUrl(collect.weburl),userUrls=angular.fromJson(localStorage.getItem("urls"));if(1==fwToolbar.inArray(userUrls,shorturl))return alert("链接已经存在"),!1;if(null!=localStorage.getItem("hostname")){var hname=localStorage.getItem("hostname");if(hname=fwToolbar.getShortUrl(hname),shorturl==hname)return collect.weburl="",alert("此域名不能加入科学上网规则"),!1}var username=localStorage.getItem("username");$http.post(faConfig.ajaxUrl+"index.php?r=option/addcollect",{token:cToken,username:username,web_url:shorturl,title:"custom",type_id:typeid}).success(function(data,status,headers,config){fwToolbar.prOtherlogin(data),1==data.code&&(userUrls.push({web_url:shorturl}),localStorage.setItem("urls",angular.toJson(userUrls)),fwToolbar.setPac(!0),fwToolbar.getAllCollect($scope.collect),collect.weburl="")}).error(function(data,status,headers,config){})}},collect.urledit=function(e,c){if(null!=collect.currentE&&collect.urlblur(),collect.editId=c.user_web_id,collect.editUrl=c.web_url,collect.currentE=e,angular.element(e.target).parent().parent().find("td").eq(0).html("<input type='test' ng-model='collect.editUrl'  />"),$compile(angular.element(e.target).parent().parent().find("td").eq(0).contents())($scope),angular.element(e.target).parent().parent().find("td").eq(1).html('<select class="form-control" ng-model="collect.editType"  ng-options="t.type_name for t in type.data"><option value="" style="display:none" >默认</option></select>'),0!=c.type_id){var index=0;angular.forEach($scope.type.data,function(value,key){return value.mwt_id==c.type_id?(index=key,void(collect.typeName=value.type_name)):void 0}),collect.editType=$scope.type.data[index]}else collect.editType="",collect.typeName="默认";$compile(angular.element(e.target).parent().parent().find("td").eq(1).contents())($scope),angular.element(e.target).parent().parent().find("td").eq(2).find("i").eq(0).css({display:"none"}),angular.element(e.target).parent().parent().find("td").eq(2).find("i").eq(1).removeAttr("style")},collect.urlblur=function(){angular.element(collect.currentE.target).parent().parent().find("td").eq(2).find("i").eq(0).removeAttr("style"),angular.element(collect.currentE.target).parent().parent().find("td").eq(2).find("i").eq(1).css({display:"none"}),angular.element(collect.currentE.target).parent().parent().find("td").eq(0).text(collect.editUrl),""!=collect.editType?angular.element(collect.currentE.target).parent().parent().find("td").eq(1).text(collect.editType.type_name):angular.element(collect.currentE.target).parent().parent().find("td").eq(1).text(collect.typeName)},collect.okedit=function(c){var typeid=0;if(""!=collect.editType&&(typeid=collect.editType.mwt_id),""==collect.editUrl)return void alert("不能为空");c.web_url=collect.editUrl,c.type_id=typeid,c.type_name=collect.typeName;var cToken=localStorage.getItem("token"),username=localStorage.getItem("username");$http.post(faConfig.ajaxUrl+"index.php?r=option/editcollect",{token:cToken,username:username,user_web_id:collect.editId,web_url:collect.editUrl,type_id:typeid}).success(function(data,status,headers,config){if(fwToolbar.prOtherlogin(data),1==data.code){var userUrls=angular.fromJson(localStorage.getItem("urls"));userUrls.push({web_url:collect.editUrl}),localStorage.setItem("urls",angular.toJson(userUrls)),fwToolbar.setPac(!0)}}).error(function(data,status,headers,config){}),collect.urlblur()},collect.remove=function(wurl){var removeState=confirm("确定移除当前域名？");if(1==removeState){var cToken=localStorage.getItem("token"),username=localStorage.getItem("username");$http.post(faConfig.ajaxUrl+"index.php?r=option/rmcollect",{token:cToken,username:username,weburl:wurl}).success(function(data,status,headers,config){if(fwToolbar.prOtherlogin(data),1==data.code){var userUrls=angular.fromJson(localStorage.getItem("urls")),newUserUrls=[];angular.forEach(userUrls,function(uurl,key){uurl.web_url!=wurl&&newUserUrls.push({web_url:uurl.web_url})}),localStorage.setItem("urls",angular.toJson(newUserUrls)),fwToolbar.setPac(!0),fwToolbar.getAllCollect($scope.collect),optionProcess.getTypeAll($scope,cToken)}}).error(function(data,status,headers,config){})}}}),optapp.controller("typeCtr",function($scope,$compile,$http,optionProcess,faConfig,fwToolbar){var type=$scope.type={},cToken=localStorage.getItem("token");optionProcess.getTypeAll($scope,cToken),type.add=function(type_form){if(type_form.$valid){var username=localStorage.getItem("username");$http.post(faConfig.ajaxUrl+"index.php?r=option/addtype",{token:cToken,username:username,tname:type.name}).success(function(data,status,headers,config){fwToolbar.prOtherlogin(data),1==data.code?(optionProcess.getTypeAll($scope,cToken),type.name=null):alert(data.msg)}).error(function(data,status,headers,config){})}},type.edit=function(e,t){null!=type.currentE&&type.typeblur(),type.editId=t.mwt_id,type.editTypeName=t.type_name,type.currentE=e,angular.element(e.target).parent().parent().find("td").eq(0).html("<input type='test' ng-model='type.editTypeName'  />"),$compile(angular.element(e.target).parent().parent().find("td").eq(0).contents())($scope),angular.element(e.target).parent().parent().find("td").eq(1).find("i").eq(0).css({display:"none"}),angular.element(e.target).parent().parent().find("td").eq(1).find("i").eq(1).removeAttr("style")},type.typeblur=function(){angular.element(type.currentE.target).parent().parent().find("td").eq(1).find("i").eq(0).removeAttr("style"),angular.element(type.currentE.target).parent().parent().find("td").eq(1).find("i").eq(1).css({display:"none"}),angular.element(type.currentE.target).parent().parent().find("td").eq(0).text(type.editTypeName)},type.okedit=function(t){if(""==type.editTypeName)return void alert("不能为空");t.type_name=type.editTypeName;var cToken=localStorage.getItem("token"),username=localStorage.getItem("username");$http.post(faConfig.ajaxUrl+"index.php?r=option/editype",{token:cToken,username:username,type_id:type.editId,type_name:type.editTypeName}).success(function(data,status,headers,config){fwToolbar.prOtherlogin(data)}).error(function(data,status,headers,config){}),type.typeblur()},type.remove=function(mwt_id){var cToken=localStorage.getItem("token"),username=localStorage.getItem("username");$http.post(faConfig.ajaxUrl+"index.php?r=option/rmtype",{token:cToken,username:username,mwtid:mwt_id}).success(function(data,status,headers,config){fwToolbar.prOtherlogin(data),1==data.code?optionProcess.getTypeAll($scope,cToken):alert(data.msg)}).error(function(data,status,headers,config){})}}),optapp.controller("orderCtr",function($scope,$http,optionProcess){var cToken=($scope.order={},localStorage.getItem("token"));optionProcess.getOrderAll($scope,cToken)}),optapp.controller("feedbackCtr",function($scope,$http,faConfig,fwToolbar){var feedback=$scope.feedback={};feedback.types=[{tag:"1",name:"我就想吐槽"},{tag:"2",name:"充值未到账"},{tag:"3",name:"改进的建议"},{tag:"4",name:"其他的问题"}],feedback.type=feedback.types[0],feedback.toSend=function(feedback_form){if(feedback_form.$valid){var cToken=localStorage.getItem("token"),username=localStorage.getItem("username");$http.post(faConfig.ajaxUrl+"index.php?r=option/sendfb",{token:cToken,username:username,type:feedback.type.name,msgcontent:feedback.msgcontent}).success(function(data,status,headers,config){fwToolbar.prOtherlogin(data),1==data.code?(feedback.msgcontent="",alert("发送成功")):alert("发送失败")}).error(function(data,status,headers,config){})}}}),optapp.controller("agentCtr",function($scope,$http,faConfig,fwToolbar){var cToken=($scope.agent={},localStorage.getItem("token")),username=localStorage.getItem("username");$http.post(faConfig.ajaxUrl+"index.php?r=option/allagent",{token:cToken,username:username}).success(function(data,status,headers,config){fwToolbar.prOtherlogin(data),$scope.agent.data=data.agent_data}).error(function(data,status,headers,config){})}),optapp.controller("payCtr",function($scope,$http,faConfig,fwToolbar,$uibModal,$location){var pay=$scope.pay={};pay.ebank=!0,pay.payTab=function(param){"ebank"===param&&(pay.ebank=!0,pay.alipay=pay.code=!1),"alipay"===param&&(pay.alipay=!0,pay.ebank=pay.code=!1),"code"===param&&(pay.code=!0,pay.alipay=pay.ebank=!1)},pay.username=localStorage.getItem("username"),null!=localStorage.getItem("hostname")?pay.baseUrl=localStorage.getItem("hostname"):pay.baseUrl=faConfig.ajaxUrl,pay.toAlipay=function(){if("undefined"==typeof pay.tnumber)return void alert("请输入交易号");var cToken=localStorage.getItem("token"),username=localStorage.getItem("username");$http.post(faConfig.ajaxUrl+"index.php?r=pay/alipayorder",{token:cToken,username:username,orderid:pay.tnumber}).success(function(data,status,headers,config){fwToolbar.prOtherlogin(data),-3==data.code&&alert("订单不存在，请等待一分钟后重试"),-4==data.code&&alert("订单已结使用"),-5==data.code&&alert("你充值的金额低于1元"),1==data.code&&(alert("充值成功"),chrome.tabs.query({active:!0,windowId:chrome.windows.WINDOW_ID_CURRENT},function(tabs){chrome.tabs.update(tabs[0].id,{url:chrome.extension.getURL("options.html#/pay")})})),pay.tnumber=""}).error(function(data,status,headers,config){})},pay.showCode=function(){$uibModal.open({animation:!0,templateUrl:"showCode.html",controller:"",size:"sm",resolve:{}})},$(".pay-btn").click(function(){var money=$(this).attr("money"),d=new Date,orderid=d.getTime()+Math.floor(999*Math.random()+1);$("#orderNo").val(orderid),0!=money&&($("#amt").val(money),$("#tradeSummary").val($(this).attr("proname")),$("#alipayment").submit())}),$("#useCode").click(function(){$("#payment").attr("action",pay.baseUrl+"index.php?r=member/usecode");var opcode=encodeURIComponent($("#invitationCode").val());$("#invitationCode").val(opcode);var d=new Date,orderid=d.getTime()+Math.floor(999*Math.random()+1);$("#corderNo").val(orderid),""!=opcode?($(this).attr("disabled","disabled"),$("#payment").submit()):alert("请输入体验码")})});