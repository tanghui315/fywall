var popapp=angular.module("popapp",["ngRoute","facapp","ngAnimate"]);popapp.config(function($routeProvider,$locationProvider){$routeProvider.when("/",{templateUrl:"/popup/default.html",controller:"popCtr"}).when("/login",{templateUrl:"/popup/login.html",controller:"loginCtr"}).when("/reg",{templateUrl:"/popup/reg.html",controller:"regCtr"})}),popapp.controller("popCtr",function($scope,$http,fwToolbar,$location,optionProcess,$window,faConfig){var popup=$scope.popup={};$scope.type={},popup.mode={demand:!0,always:!1,close:!1};var cToken=localStorage.getItem("token");if(null==cToken&&(chrome.browserAction.setIcon({path:"images/icon-never.png"},function(){}),$location.path("/login")),fwToolbar.checkToken(cToken),popup.username=localStorage.getItem("username"),null!=localStorage.getItem("hostname")?popup.baseUrl=localStorage.getItem("hostname"):popup.baseUrl=faConfig.ajaxUrl,popup.days=localStorage.getItem("days"),optionProcess.getTypeAll($scope,cToken),chrome.tabs.query({active:!0,windowId:chrome.windows.WINDOW_ID_CURRENT},function(tabs){if(popup.currentTabId=tabs[0].id,popup.currentUrl=tabs[0].url,popup.shortUrl=fwToolbar.getShortUrl(tabs[0].url),popup.fullShortUrl=fwToolbar.getFullShortUrl(tabs[0].url),popup.titleUrl=tabs[0].title,popup.favIconUrl=tabs[0].favIconUrl,popup.isHave=!1,popup.isoption=!1,popup.days<1&&(popup.shortUrl=!1),popup.shortUrl){var userUrls=angular.fromJson(localStorage.getItem("urls"));1==fwToolbar.inArray(userUrls,popup.shortUrl)&&(popup.isHave=!0)}else popup.isoption=!0;if(popup.errUrlArr=angular.fromJson(localStorage.getItem("errUrls"+tabs[0].id)),popup.isErrHave=!1,popup.oldIsHave=popup.isHave,popup.oldIsErrHave=popup.isErrHave,null!=localStorage.getItem("mode")){var mode=localStorage.getItem("mode");(3==parseInt(mode)||2==parseInt(mode))&&(popup.isHave=!0,popup.isErrHave=!0)}}),null!=localStorage.getItem("mode")){var mode=localStorage.getItem("mode");1==parseInt(mode)&&(popup.mode={demand:!0,always:!1,close:!1}),2==parseInt(mode)&&(popup.mode={demand:!1,always:!0,close:!1}),3==parseInt(mode)&&(popup.mode={demand:!1,always:!1,close:!0})}popup.toAdd=function(){var cToken=localStorage.getItem("token"),typeid=0;"undefined"!=typeof popup.type&&(typeid=popup.type.mwt_id);var username=localStorage.getItem("username");if(null!=localStorage.getItem("hostname")){var hname=localStorage.getItem("hostname");if(hname=fwToolbar.getShortUrl(hname),popup.shortUrl==hname)return popup.msg="此域名不能加入科学上网规则",!1}$http.post(faConfig.ajaxUrl+"index.php?r=option/addcollect",{token:cToken,username:username,web_url:popup.shortUrl,title:popup.titleUrl,type_id:typeid}).success(function(data,status,headers,config){if(fwToolbar.prOtherlogin(data),1==data.code){var userUrls=angular.fromJson(localStorage.getItem("urls"));userUrls.push({web_url:popup.shortUrl}),localStorage.setItem("urls",angular.toJson(userUrls)),fwToolbar.setPac(!0),chrome.tabs.update(popup.currentTabId,{url:popup.currentUrl})}}).error(function(data,status,headers,config){})},popup.remove=function(){var cToken=localStorage.getItem("token"),username=localStorage.getItem("username");$http.post(faConfig.ajaxUrl+"index.php?r=option/rmcollect",{token:cToken,username:username,weburl:popup.shortUrl}).success(function(data,status,headers,config){if(fwToolbar.prOtherlogin(data),1==data.code){var userUrls=angular.fromJson(localStorage.getItem("urls")),newUserUrls=[];angular.forEach(userUrls,function(uurl,key){uurl.web_url!=popup.shortUrl&&newUserUrls.push({web_url:uurl.web_url})}),localStorage.setItem("urls",angular.toJson(newUserUrls)),fwToolbar.setPac(!0),chrome.tabs.reload(popup.currentTabId)}}).error(function(data,status,headers,config){})},popup.toAddAll=function(){var cToken=localStorage.getItem("token"),errUrls=localStorage.getItem("errUrls"+popup.currentTabId),username=localStorage.getItem("username");$http.post(faConfig.ajaxUrl+"index.php?r=option/addcollectm",{token:cToken,username:username,errurls:errUrls}).success(function(data,status,headers,config){if(fwToolbar.prOtherlogin(data),1==data.code){var errUrlArr=angular.fromJson(errUrls);if(null!=errUrls){var userUrls=angular.fromJson(localStorage.getItem("urls"));angular.forEach(errUrlArr,function(url,key){userUrls.push({web_url:url})}),localStorage.setItem("urls",angular.toJson(userUrls)),fwToolbar.setPac(!0)}chrome.tabs.update(popup.currentTabId,{url:popup.currentUrl})}}).error(function(data,status,headers,config){})},popup.toSet=function(){chrome.tabs.update(popup.currentTabId,{url:chrome.extension.getURL("options.html")}),$window.close()},popup.toppay=function(){chrome.tabs.update(popup.currentTabId,{url:chrome.extension.getURL("options.html#/pay")}),$window.close()},popup.logOut=function(){localStorage.removeItem("token"),chrome.tabs.update(popup.currentTabId,{url:chrome.extension.getURL("login.html")}),$window.close()},popup.onDemand=function(){popup.mode={demand:!0,always:!1,close:!1},localStorage.setItem("mode",1),fwToolbar.setPac(!0),popup.isHave=popup.oldIsHave,popup.isErrHave=popup.oldIsErrHave},popup.onAlways=function(){popup.mode={demand:!1,always:!0,close:!1},localStorage.setItem("mode",2),chrome.browserAction.setIcon({path:"images/icon-auto-active.png"},function(){}),fwToolbar.setAlwaysPac(!0),popup.isHave=!0,popup.isErrHave=!0},popup.onClose=function(){popup.mode={demand:!1,always:!1,close:!0},fwToolbar.setPac(!1),fwToolbar.setAlwaysPac(!1),chrome.browserAction.setIcon({path:"images/fw.png"},function(){}),localStorage.setItem("mode",3),popup.isHave=!0,popup.isErrHave=!0}}),popapp.controller("loginCtr",function($scope,$http,fwToolbar,faConfig,fwConnect,$location,$window){var login=$scope.login={};login.submitLogin=function(login_form,e){login_form.$valid&&(login.dis=!0,$http.post(faConfig.ajaxUrl+"index.php?r=member/login",{user_name:login.email,pwd:login.pwd}).success(function(data,status,headers,config){if(1==data.code){localStorage.setItem("token",data.access_token),localStorage.setItem("username",login.email),localStorage.setItem("urls",angular.toJson(data.web_url_arr)),localStorage.setItem("ps",data.s),localStorage.setItem("pss",data.ss),localStorage.setItem("days",data.expire_days),localStorage.setItem("version",data.version),localStorage.setItem("mode",1);var d=new Date;localStorage.setItem("logintime",d.getTime()),localStorage.setItem("hostname",data.host_name),fwToolbar.setPac(!0),chrome.browserAction.setIcon({path:"images/fw.png"},function(){}),chrome.browserAction.setBadgeText({text:""}),$location.path("/")}else alert(data.msg),login.dis=!1,chrome.browserAction.setIcon({path:"images/icon-never.png"},function(){}),chrome.browserAction.setBadgeText({text:""})}).error(function(data,status,headers,config){}))},login.toForgot=function(){chrome.tabs.query({active:!0,windowId:chrome.windows.WINDOW_ID_CURRENT},function(tabs){chrome.tabs.update(tabs[0].id,{url:chrome.extension.getURL("forgot.html")})}),$window.close()}}),popapp.controller("regCtr",function($scope,$http,faConfig,fwToolbar,$location){var member=$scope.member={};member.submitReg=function(reg_form){reg_form.$valid&&(member.dis=!0,$http.post(faConfig.ajaxUrl+"index.php?r=member/create",{user_name:member.email,mail_code:member.email_code,pwd:member.pwd}).success(function(data,status,headers,config){if(1==data.code){localStorage.setItem("token",data.access_token),localStorage.setItem("username",member.email),localStorage.setItem("urls",angular.toJson(data.web_url_arr)),localStorage.setItem("ps",data.s),localStorage.setItem("pss",data.ss),localStorage.setItem("days",data.expire_days),localStorage.setItem("version",data.version),localStorage.setItem("hostname",data.host_name),localStorage.setItem("mode",1);var d=new Date;localStorage.setItem("logintime",d.getTime()),fwToolbar.setPac(!0),chrome.browserAction.setIcon({path:"images/fw.png"},function(){}),chrome.browserAction.setBadgeText({text:""}),$location.path("/")}else alert(data.msg),member.dis=!1,chrome.browserAction.setIcon({path:"images/icon-never.png"},function(){}),chrome.browserAction.setBadgeText({text:""})}).error(function(data,status,headers,config){}))},member.sendCode=function(reg_form){member.code_msg="邮件正在发送中...",reg_form.member_email.$valid?$http.post(faConfig.ajaxUrl+"index.php?r=member/ckmail",{user_name:reg_form.member_email.$viewValue}).success(function(data,status,headers,config){1==data.code?member.code_msg="发送成功，请查收邮件":member.code_msg=data.msg}).error(function(data,status,headers,config){}):member.code_msg="请输入邮箱地址"}});