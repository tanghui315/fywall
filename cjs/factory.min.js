var facapp=angular.module("facapp",[]);facapp.value("faConfig",{ajaxUrl:"http://106.75.133.227/"}),facapp.factory("fwToolbar",function($http,faConfig){var service={};return service.getShortUrl=function(detailsUrl){detailsUrl=service.UrlDecode(detailsUrl);var urlRegex=/(https?:\/\/[^\s]+)\//gi,m=detailsUrl.match(urlRegex);if(!m)return!1;if(detailsUrl=m[0],-1==detailsUrl.indexOf("."))return!1;var tmparr=new URL(detailsUrl).hostname.split(".");if("cn"!=tmparr.slice(-1).toString()&&(tmparr.length>2&&(tmparr=tmparr.slice(tmparr.length-2)),2==tmparr.length)){var shortUrl=tmparr[0]+"."+tmparr[1];return shortUrl}return!1},service.cktokenServer=function(cToken){var username=localStorage.getItem("username");$http.post(faConfig.ajaxUrl+"index.php?r=option/ctoken",{token:cToken,username:username}).success(function(data,status,headers,config){1!=data.code&&localStorage.removeItem("token")}).error(function(data,status,headers,config){})},service.getFullShortUrl=function(detailsUrl){detailsUrl=service.UrlDecode(detailsUrl);var urlRegex=/(https?:\/\/[^\s]+)\//gi,m=detailsUrl.match(urlRegex);if(!m)return!1;if(detailsUrl=m[0],-1==detailsUrl.indexOf("."))return!1;var tmparr=new URL(detailsUrl).hostname.split(".");if(tmparr.length>=3){tmparr=tmparr.slice(tmparr.length-3);var shortUrl=tmparr[0]+"."+tmparr[1]+"."+tmparr[2];return shortUrl}if(2==tmparr.length){var shortUrl=tmparr[0]+"."+tmparr[1];return shortUrl}return!1},service.prOtherlogin=function(data){return-2==data.code?(localStorage.removeItem("token"),localStorage.removeItem("username"),localStorage.removeItem("urls"),void service.setPac(!1)):void(data.cdata&&(localStorage.setItem("days",data.cdata.vipdays),localStorage.setItem("version",data.cdata.version),localStorage.setItem("ps",data.cdata.ps)))},service.checkToken=function(cToken){null==cToken&&(chrome.browserAction.setIcon({path:"images/icon-never.png"},function(){}),chrome.browserAction.setBadgeText({text:""}))},service.inArray=function(userUrls,shortUrl){var tmpt=!1;return angular.forEach(userUrls,function(value,key){return value.web_url==shortUrl?(tmpt=!0,!1):void 0}),tmpt},service.judgmentErr=function(tabId){if(localStorage.getItem("errUrls"+tabId)){var errUrlJosn=localStorage.getItem("errUrls"+tabId),errUrlArr=angular.fromJson(errUrlJosn);errUrlArr.length>0?chrome.browserAction.setBadgeText({text:errUrlArr.length.toString()}):chrome.browserAction.setBadgeText({text:""})}},service.setUrlerrSpro=function(tabId,currentUrl){var cToken=localStorage.getItem("token"),errUrls=localStorage.getItem("errUrls"+tabId),username=localStorage.getItem("username");null!=errUrls&&$http.post(faConfig.ajaxUrl+"index.php?r=option/addcollectm",{token:cToken,username:username,errurls:errUrls}).success(function(data,status,headers,config){if(service.prOtherlogin(data),1==data.code){var errUrlArr=angular.fromJson(errUrls);if(null!=errUrls){var userUrls=angular.fromJson(localStorage.getItem("urls"));angular.forEach(errUrlArr,function(url,key){userUrls.push({web_url:url})}),localStorage.setItem("urls",angular.toJson(userUrls)),service.setPac(!0)}chrome.tabs.update(tabId,{url:currentUrl})}}).error(function(data,status,headers,config){})},service.pacg=function(ps){var pss=localStorage.getItem("pss");pss=angular.fromJson(pss);var proxyString=pss.ssway+" "+ps.host+":"+ps.port+";";lines=[],lines.push(["function Find","roxyForURL(url, host) {\n"].join("P")),lines.push('var D = "DIRECT";'),lines.push("var p='"+proxyString+"';\n"),lines.push("if (shExpMatch(host, '10.[0-9]+.[0-9]+.[0-9]+')) return D;"),lines.push("if (shExpMatch(host, '172.[0-9]+.[0-9]+.[0-9]+')) return D;"),lines.push("if (shExpMatch(host, '192.168.[0-9]+.[0-9]+')) return D;"),lines.push("if (dnsDomainIs(host, 'localhost')) return D;\n"),lines.push("if (dnsDomainIs(host, '127.0.0.1')) return D;"),lines.push("var node = "+localStorage.getItem("urls")+";"),lines.push("if(host.indexOf('.')==-1){return D;}"),lines.push("var hostParts = host.toLowerCase().split('.');"),lines.push("var shortUrl='';"),lines.push("if(hostParts.slice(-1).toString()=='cn'){ return D; }"),lines.push("if(hostParts.length>2){ hostParts=hostParts.slice((hostParts.length-2)); }"),lines.push("if(hostParts.length==2){ shortUrl=hostParts[0]+'.'+hostParts[1]; }"),lines.push("if(shortUrl==''){ return D; }"),lines.push("for(var i=0;i<node.length;i++){if(node[i].web_url==shortUrl){return p; break;}}"),lines.push("return D;}");var source=lines.join("\n");return source},service.setPac=function(p){var ps=localStorage.getItem("ps");if(0==p||"no"==ps)return chrome.proxy.settings.clear({}),!1;var source=service.pacg(angular.fromJson(ps)),config={mode:"pac_script",pacScript:{data:source}};chrome.proxy.settings.set({value:config,scope:"regular"},function(){return null})},service.setAlwaysPac=function(p){var ps=localStorage.getItem("ps");if(0==p||"no"==ps)return chrome.proxy.settings.clear({}),!1;var source=service.alwaysPacg(angular.fromJson(ps)),config={mode:"pac_script",pacScript:{data:source}};chrome.proxy.settings.set({value:config,scope:"regular"},function(){return null})},service.alwaysPacg=function(ps){var pss=localStorage.getItem("pss");pss=angular.fromJson(pss);var proxyString=pss.ssway+" "+ps.host+":"+ps.port+";";lines=[],lines.push(["function Find","roxyForURL(url, host) {\n"].join("P")),lines.push('var D = "DIRECT";'),lines.push("var p='"+proxyString+"';\n"),lines.push("if (shExpMatch(host, '10.[0-9]+.[0-9]+.[0-9]+')) return D;"),lines.push("if (shExpMatch(host, '172.[0-9]+.[0-9]+.[0-9]+')) return D;"),lines.push("if (shExpMatch(host, '192.168.[0-9]+.[0-9]+')) return D;"),lines.push("if (dnsDomainIs(host, 'localhost')) return D;\n"),lines.push("if (dnsDomainIs(host, '127.0.0.1')) return D;"),lines.push("return p;}");var source=lines.join("\n");return source},service.testpac=function(){var node=[{web_url:"google.com"},{web_url:"dwnews.com"},{web_url:"ip138.com"}],testUrl="www.google.com";if(-1==testUrl.indexOf("."))return!1;var tmparr=testUrl.toLowerCase().split("."),shortUrl="";if("cn"!=tmparr.slice(-1).toString()&&(tmparr.length>2&&(tmparr=tmparr.slice(tmparr.length-2)),2==tmparr.length&&(shortUrl=tmparr[0]+"."+tmparr[1])),""!=shortUrl)for(var i=0;i<node.length&&node[i].web_url!=shortUrl;i++);},service.getAllCollect=function(collect){var cToken=localStorage.getItem("token"),username=localStorage.getItem("username");$http.post(faConfig.ajaxUrl+"index.php?r=option/allcollect",{token:cToken,username:username}).success(function(data,status,headers,config){service.prOtherlogin(data),collect.data=data.collect_data}).error(function(data,status,headers,config){})},service.UrlDecode=function(str){for(var ret="",i=0;i<str.length;i++){var chr=str.charAt(i);if("+"==chr)ret+=" ";else if("%"==chr){var asc=str.substring(i+1,i+3);parseInt("0x"+asc)>127?(ret+=String.fromCharCode(parseInt("0x"+asc+str.substring(i+4,i+6))),i+=5):(ret+=String.fromCharCode(parseInt("0x"+asc)),i+=2)}else ret+=chr}return ret},service}),facapp.factory("optionProcess",function($http,faConfig,fwToolbar){var service={};return service.getTypeAll=function($scope,cToken){var username=localStorage.getItem("username");$http.post(faConfig.ajaxUrl+"index.php?r=option/alltype",{token:cToken,username:username}).success(function(data,status,headers,config){fwToolbar.prOtherlogin(data),$scope.type.data=data.type_data}).error(function(data,status,headers,config){})},service.getOrderAll=function($scope,cToken){var username=localStorage.getItem("username");$http.post(faConfig.ajaxUrl+"index.php?r=option/allorder",{token:cToken,username:username}).success(function(data,status,headers,config){fwToolbar.prOtherlogin(data),$scope.order.data=data.order_data}).error(function(data,status,headers,config){})},service}),facapp.factory("fwConnect",function($http,faConfig,fwToolbar){var heartbeat_timer=0,last_health=-1,health_timeout=5e3,service={};return service.keepalive=function(ws){var time=new Date;-1!=last_health&&time.getTime()-last_health>health_timeout?ws.close():0==ws.bufferedAmount&&(null!=localStorage.getItem("token")?(ws.send(localStorage.getItem("token")),clearInterval(heartbeat_timer)):ws.send("notoken"))},service.wsConn=function(to_url){if(to_url=to_url||"",""==to_url)return!1;clearInterval(heartbeat_timer);var ws=new WebSocket(to_url);return ws.onopen=function(){heartbeat_timer=setInterval(function(){service.keepalive(ws)},health_timeout)},ws.onerror=function(){clearInterval(heartbeat_timer)},ws.onclose=function(){clearInterval(heartbeat_timer)},ws.onmessage=function(msg){var time=new Date;rdata=angular.fromJson(msg.data);var ltime=localStorage.getItem("logintime");-1==rdata.islogin?null!=ltime?time.getTime()-ltime>6e5&&(localStorage.removeItem("token"),localStorage.removeItem("username"),localStorage.removeItem("urls")):(localStorage.removeItem("token"),localStorage.removeItem("username"),localStorage.removeItem("urls")):(localStorage.setItem("days",rdata.vipdays),localStorage.setItem("version",rdata.version),localStorage.setItem("ps",rdata.ps)),last_health=time.getTime()},ws},service});